<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simple Chat</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    background: #f4f4f4;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  #roomSelector {
    padding: 16px;
    text-align: center;
    background: #333;
    color: white;
  }
  #roomSelector input[type="text"], #roomSelector input[type="color"] {
    font-size: 1em;
    padding: 8px;
    border-radius: 4px;
    border: none;
    margin-right: 8px;
  }
  #roomSelector input[type="color"] {
    width: 80px;
    vertical-align: middle;
  }
  #roomSelector button {
    font-size: 1em;
    padding: 8px 16px;
    border-radius: 4px;
    border: none;
    background: #06c;
    color: white;
    cursor: pointer;
  }
  #roomSelector button:hover {
    background: #005bb5;
  }

  #chat {
    display: none;
    flex-direction: column;
    flex: 1;
    overflow: hidden;
  }
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    -webkit-overflow-scrolling: touch;
  }
  .msg {
    margin-bottom: 8px;
    padding: 8px 12px;
    border-radius: 8px;
    background: white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    word-break: break-word;
  }
  .colorCircle {
    display: inline-block;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    vertical-align: middle;
    margin-right: 6px;
    border: 1px solid #555;
  }
  .username {
    font-weight: bold;
    margin-right: 6px;
    vertical-align: middle;
  }
  .timestamp {
    font-size: 0.8em;
    color: #666;
    vertical-align: middle;
  }
  .msg-header {
    margin-bottom: 4px;
  }
  .msg-text {
    white-space: pre-wrap;
  }
  .msg-buttons {
    margin-top: 6px;
    text-align: right;
  }
  .msg-buttons button {
    font-size: 0.8em;
    padding: 4px 8px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    background: #d33;
    color: white;
  }
  .msg-buttons button:hover {
    background: #a00;
  }

  #inputContainer {
    display: flex;
    padding: 10px;
    background: #eee;
    gap: 8px;
  }
  #input {
    flex: 1;
    padding: 10px;
    font-size: 1em;
    border-radius: 6px;
    border: 1px solid #ccc;
    resize: none;
  }
  #input:focus {
    outline: none;
    border-color: #06c;
  }
  #sendBtn {
    font-size: 1em;
    padding: 10px 18px;
    border-radius: 6px;
    border: none;
    background: #06c;
    color: white;
    cursor: pointer;
  }
  #sendBtn:hover {
    background: #005bb5;
  }

  /* Responsive */
  @media (max-width: 600px) {
    #roomSelector {
      padding: 12px;
    }
    #roomSelector input[type="text"], #roomSelector input[type="color"] {
      font-size: 1em;
      padding: 8px;
      margin-bottom: 8px;
      width: 100%;
      display: block;
    }
    #roomSelector button {
      width: 100%;
      padding: 10px 0;
      font-size: 1.1em;
    }
    #inputContainer {
      padding: 8px;
    }
    #sendBtn {
      padding: 10px 12px;
      font-size: 1em;
    }
  }
</style>
</head>
<body>

<div id="roomSelector">
  <input id="roomCode" type="text" placeholder="Enter room code" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
  <input id="colorPicker" type="color" value="#000000" title="Pick your color" />
  <input id="colorHex" type="text" maxlength="7" size="7" value="#000000" style="font-family: monospace; padding:6px; border-radius:4px; border:none; width:70px; vertical-align:middle;" title="Edit HEX color code (#RRGGBB)" />
  <button id="joinBtn">Join Room</button>
</div>

<div id="chat">
  <div id="messages"></div>
  <div id="inputContainer">
    <textarea id="input" rows="2" placeholder="Type a message..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" ></textarea>
    <button id="sendBtn">Send</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  const roomCodeInput = document.getElementById('roomCode');
  const colorPicker = document.getElementById('colorPicker');
  const colorHex = document.getElementById('colorHex');
  const joinBtn = document.getElementById('joinBtn');
  const chatDiv = document.getElementById('chat');
  const messagesDiv = document.getElementById('messages');
  const input = document.getElementById('input');
  const sendBtn = document.getElementById('sendBtn');

  let roomCode = '';
  let userColor = '#000000'; // default

  // Load saved color from localStorage if any
  const savedColor = localStorage.getItem('chatUserColor');
  if(savedColor && /^#[0-9a-fA-F]{6}$/.test(savedColor)) {
    userColor = savedColor;
    colorPicker.value = userColor;
    colorHex.value = userColor;
  } else {
    // Save default
    localStorage.setItem('chatUserColor', userColor);
  }

  // Sync color picker <-> HEX input
  colorPicker.addEventListener('input', () => {
    userColor = colorPicker.value;
    colorHex.value = userColor.toUpperCase();
    localStorage.setItem('chatUserColor', userColor);
  });

  colorHex.addEventListener('input', () => {
    let val = colorHex.value.toUpperCase();
    if(!val.startsWith('#')) val = '#' + val;
    if(/^#[0-9A-F]{6}$/.test(val)) {
      userColor = val;
      colorPicker.value = userColor;
      localStorage.setItem('chatUserColor', userColor);
    }
  });

  // Disable message input suggestions
  input.setAttribute('autocomplete', 'off');
  input.setAttribute('autocorrect', 'off');
  input.setAttribute('autocapitalize', 'off');
  input.setAttribute('spellcheck', 'false');

  joinBtn.onclick = () => {
    roomCode = roomCodeInput.value.trim();
    if(!roomCode) {
      alert('Please enter a room code.');
      return;
    }
    socket.emit('joinRoom', { roomCode, colorName: userColor });
    document.getElementById('roomSelector').style.display = 'none';
    chatDiv.style.display = 'flex';
    input.focus();
  };

  sendBtn.onclick = sendMessage;
  input.addEventListener('keydown', e => {
    if(e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  function sendMessage() {
    const text = input.value.trim();
    if(!text) return;
    socket.emit('message', { text });
    input.value = '';
  }

  // Receive messages
  socket.on('message', msg => {
    addMessage(msg);
  });

  socket.on('loadMessages', msgs => {
    messagesDiv.innerHTML = '';
    msgs.forEach(m => addMessage(m));
  });

  socket.on('messageDeleted', id => {
    const el = document.getElementById(id);
    if(el) el.remove();
  });

  function formatTime(iso) {
    const d = new Date(iso);
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  }

  function addMessage(msg) {
    if(document.getElementById(msg._id)) return; // Prevent duplicates

    const div = document.createElement('div');
    div.className = 'msg';
    div.id = msg._id;
    div.style.background = hexToRgba(msg.colorName, 0.07);

    // Header with color circle, username (color), timestamp
    const header = document.createElement('div');
    header.className = 'msg-header';

    const circle = document.createElement('span');
    circle.className = 'colorCircle';
    circle.style.backgroundColor = msg.colorName;

    const usernameSpan = document.createElement('span');
    usernameSpan.className = 'username';
    usernameSpan.style.color = msg.colorName;
    usernameSpan.textContent = msg.colorName;

    const timeSpan = document.createElement('span');
    timeSpan.className = 'timestamp';
    timeSpan.textContent = ` (${formatTime(msg.createdAt)})`;

    header.appendChild(circle);
    header.appendChild(usernameSpan);
    header.appendChild(timeSpan);

    // Message text
    const textDiv = document.createElement('div');
    textDiv.className = 'msg-text';
    textDiv.textContent = msg.text;

    div.appendChild(header);
    div.appendChild(textDiv);

    // Only show delete button if message is from current user
    if(msg.senderId === socket.id) {
      const btnDiv = document.createElement('div');
      btnDiv.className = 'msg-buttons';

      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.onclick = () => {
        if(confirm('Delete this message?')) {
          socket.emit('deleteMessage', msg._id);
          div.remove();
        }
      };

      btnDiv.appendChild(delBtn);
      div.appendChild(btnDiv);
    }

    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // Helper: convert HEX to rgba string
  function hexToRgba(hex, alpha) {
    const r = parseInt(hex.substr(1,2),16);
    const g = parseInt(hex.substr(3,2),16);
    const b = parseInt(hex.substr(5,2),16);
    return `rgba(${r},${g},${b},${alpha})`;
  }
</script>

</body>
</html>

