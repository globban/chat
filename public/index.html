<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>DB chat</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    margin: 0;
    background: #121212;
    color: #eee;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  label {
    color: #fff;
    font-size: 0.97em;
    margin-bottom: 0.2em;
    background: none;
    display: flex;
    align-items: center;
    gap: 0.5em;
    font-weight: 500;
  }
  #joinSection, #chatSection {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 0;
    padding: 0;
  }
  #joininput {
    display: flex;
    flex-direction: column;
    gap: 1.1em;
    background: #232323;
    padding: 2em 2em 1.5em 2em;
    border-radius: 10px;
    box-shadow: 0 2px 16px #0008;
    min-width: 260px;
    max-width: 90vw;
    align-items: stretch;
  }
  #nameInput, #roomInput {
    width: 100%;
    max-width: 260px;
    padding: 0.7em 1em;
    font-size: 1em;
    border: none;
    border-radius: 4px;
    background: #181818;
    color: #eee;
    margin-bottom: 0.2em;
    outline: none;
    box-sizing: border-box;
    transition: box-shadow 0.2s;
  }
  #nameInput:focus, #roomInput:focus {
    box-shadow: 0 0 0 2px #06c;
  }
  #colorInput {
    width: 38px;
    height: 32px;
    border: none;
    background: none;
    cursor: pointer;
    padding: 0;
    border-radius: 6px;
    box-shadow: 0 0 0 1px #444;
    transition: box-shadow 0.2s;
    margin: 0;
    vertical-align: middle;
    display: inline-block;
  }
  #colorInput:focus {
    box-shadow: 0 0 0 2px #06c;
    outline: none;
  }
  #joinBtn {
    width: 100%;
    padding: 0.8em 0;
    font-size: 1.1em;
    background: #06c;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 0.5em;
    transition: background 0.2s;
    font-weight: 600;
    letter-spacing: 0.03em;
  }
  #joinBtn:hover {
    background: #005bb5;
  }
  #chatSection {
    width: 100vw;
    max-width: 100vw;
    height: 100vh;
    padding: 0;
    justify-content: flex-start;
    align-items: stretch;
  }
  #messages {
    flex: 1;
    overflow-y: auto;
    background: #1e1e1e;
    border: 1px solid #333;
    padding: 1em;
    margin: 0;
    border-radius: 0 0 8px 8px;
    min-height: 0;
  }
  .msg {
    padding: 0.5em 0.8em;
    margin-bottom: 0.5em;
    background: #232323;
    border-radius: 5px;
    word-break: break-word;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 1em;
  }
  .msg button {
    background: none;
    border: none;
    color: #888;
    cursor: pointer;
    font-size: 1.1em;
    margin-left: 0.5em;
    padding: 0.1em 0.3em;
    border-radius: 3px;
    transition: background 0.2s, color 0.2s;
  }
  .msg button:hover {
    color: #fff;
    background: #333;
  }
  #messageInputBar {
    display: flex;
    gap: 0.5em;
    padding: 1em;
    background: #181818;
    border-radius: 0 0 8px 8px;
    border-top: 1px solid #222;
    position: sticky;
    bottom: 0;
    z-index: 2;
  }
  #messageInput {
    flex: 1;
    padding: 0.7em 1em;
    font-size: 1em;
    border: none;
    border-radius: 4px;
    background: #232323;
    color: #eee;
    outline: none;
    box-sizing: border-box;
    transition: box-shadow 0.2s;
  }
  #messageInput:focus {
    box-shadow: 0 0 0 2px #06c;
  }
  #sendBtn {
    padding: 0.7em 1.5em;
    font-size: 1em;
    background: #06c;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
    font-weight: 600;
    letter-spacing: 0.03em;
  }
  #sendBtn:hover {
    background: #005bb5;
  }
  @media (max-width: 600px) {
    #joininput {
      min-width: 0;
      padding: 1em;
      max-width: 98vw;
    }
    #nameInput, #roomInput {
      width: 100%;
      font-size: 1em;
      max-width: 100%;
    }
    #messages {
      padding: 0.5em;
      font-size: 0.97em;
    }
    #messageInputBar {
      padding: 0.5em;
    }
    label {
      font-size: 1em;
    }
  }
</style>
</head>
<body>
<div id="joinSection">
  <div id="joininput">
    <input id="nameInput" placeholder="Name or alias" maxlength="20"/>
    <label>Color: <input id="colorInput" type="color"></label>
    <input id="roomInput" placeholder="Enter room code" />
    <button id="joinBtn">Join</button>
  </div>
</div>

<div id="chatSection" style="display:none;">
  <div id="messages"></div>
  <div id="messageInputBar">
    <input id="messageInput" autocomplete="off" placeholder="Type message..." />
    <button id="sendBtn">Send</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

const roomInput = document.getElementById("roomInput");
const nameInput = document.getElementById("nameInput");
const colorInput = document.getElementById("colorInput");
const joinBtn = document.getElementById("joinBtn");
const joinSection = document.getElementById("joinSection");
const chatSection = document.getElementById("chatSection");
const messagesDiv = document.getElementById("messages");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");

// Load last color + name
if(localStorage.color){
  colorInput.value = localStorage.color;
}
if(localStorage.name){
  nameInput.value = localStorage.name;
}

joinBtn.onclick = () => {
  const roomCode = roomInput.value.trim();
  const userName = nameInput.value.trim() || "Anonymous";
  const colorHex = colorInput.value.trim().toLowerCase();
  if(!roomCode) return;

  localStorage.color = colorHex;
  localStorage.name = userName;

  socket.emit("joinRoom", { roomCode, userName, color: colorHex });
  joinSection.style.display = "none";
  chatSection.style.display = "flex";
};

sendBtn.onclick = () => {
  const text = messageInput.value;
  if (text.trim()) {
    socket.emit("message", { text });
    messageInput.value = "";
  }
};

socket.on("loadMessages", msgs => {
  messagesDiv.innerHTML = "";
  msgs.forEach(renderMessage);
});

socket.on("message", renderMessage);

socket.on("messageDeleted", id => {
  const el = document.getElementById("msg"+id);
  if(el) el.remove();
});

function renderMessage(msg){
  const div = document.createElement("div");
  div.className = "msg";
  div.id = "msg"+msg._id;
  div.innerHTML = `
    <span style="color:${msg.color}; font-weight:bold;">${msg.userName}</span>: ${msg.text}
    ${msg.senderId===socket.id ? `<button onclick="deleteMsg('${msg._id}')">üóëÔ∏è</button>`:""}
  `;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function deleteMsg(id){
  socket.emit("deleteMessage", id);
}
</script>
</body>
</html>
